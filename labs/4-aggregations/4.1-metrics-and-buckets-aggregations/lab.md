### Aggregations

- A flexible and powerful capability for analyzing data
  - Summarizes your data as metrics, statistics, or other analytics
  - Results are tipically computed values that can be grouped

| Aggregation   | Capability                                                                   |
|---------------|------------------------------------------------------------------------------|
| Metric        | Calculate metrics, such as sum or avarage, from field values                 |
| Bucket        | Group documents into buckets based on field values, ranges, or other criteria|
| Pipeline      | Take input fromm other aggregations instead of documents or fields           |

### Basic Structure of Aggregations

- Run aggregations as part of a search request
  - Use the `aggs` or `aggregations` element in the request body

```http
GET blogs/_search
{
  "aggs": {
    "agg_name": {
      "aggregation_type": {
        ...
      }
    }
  }
}
```

### Aggregation Results

- Aggregation results are returned in the `aggregations` section of the search response
  - Each aggregation is identified by the name you provided in the request

```json
{
  ...
  "aggregations": {
    "agg_name": {
      ...
    }
  }
}
```

To return only aggregation results without any search hits, set the `size` parameter to `0` in the search request or use the `_search` endpoint with `size=0`. (`GET blogs/_search?size=0`)

### Metric Aggregations

- Metric aggregations compute numeric values based on your dataset
  - Field values
  - Values generated by custom scripts
- Most metrics output a single value:
  - `count`, `avg`, `sum`, `min`, `max`, `median`, `cardinality`, etc.
- Some metrics output multiple values:
  - `stats`, `percentiles`, `percentile_ranks`, etc.

### The min/max Aggregation

- Returns the minimumm/maximum value among numeric values extracted from the aggregated documents

```http
GET blogs/_search?size=0
{
  "aggs": {
    "first_blog": {
      "min/max": {
        "field": "publish_date"
      }
    }
  }
}
```

### The value_count Aggregation

- Counts the number of values that are extracted from the aggregated documents
  - If a field has duplicates, each value wwill be counted individually

```http
GET blogs/_search?size=0
{
  "aggs": {
    "no_of_authors": {
      "value_count": {
        "field": "author.last_name.keyword"
      }
    }
  }
}
```

### The cardinality Aggregation

- Coounts the number of distinct occurences
- The result may not be exactly precise for large datasets
  - Based on HyperLogLog++ algorithm
  - Trades accuracy over speed

```http
GET blogs/_search?size=0
{
  "aggs": {
    "unique_authors": {
      "cardinality": {
        "field": "author.last_name.keyword"
      }
    }
  }
}
```

### Bucket Aggregations

- Group documents according to certain criterion

- Bucket by Time Period:
  - Date Range
  - Date Histogram
- Bucket by Numerics
  - Range
  - Histogram
- Bucket by Keywords
  - Terms
  - Significant Terms
- Bucket by IP Addresses
  - IPV4 Range

### The date_histogram Aggregation

- Bucket aggregation used with time-based data
- Inerval is specified using one of two ways;
  - calendar_interval:
    - calendar unit name sush as dayy, month, or year (1d, 1M, or 1y)
  - fixed_interval:
    - SI unit name such as second, minute, hour, day (s, m, h, or d)

```http
GET blogs/_search?size=0
{
  "aggs": {
    "blogs_by_month": {
      "date_histogram": {
        "field": "publish_date",
        "calendar_interval": "month"
      }
    }
  }
}
```

### The histogram Aggregation

- Bucket aggregation that builds a histogram
  - on a given field
  - using a specified interval
- similar to date histogram

```http
GET sample_data_logs/_search?size=0
{
  "aggs": {
    "logs_histogramm": {
      "histogram": {
        "field": "runtime_ms",
        "interval": 100
      }
    }
  }
}
```

## Bucket Sorting

- Some aggregations enable you to specify the sorting order

- terms
  - Default: _count in descending order
- histogram and date_histogram
  - Default: _key in ascending order

```http
GET blogs/_search?size=0
{
  "aggs": {
    "blogs_by_month": {
      "date_histogram": {
        "field": "publish_date",
        "calendar_interval": "month",
        "order": { "_key": "desc" }
      }
    }
  }
}
```

### The terms Aggregation

- Dynamically create a new bucket for every unique term of a specified field
- Search for the types of people creating blogs by their job tile:

```http
GET blogs/_search?size=0
{
  "aggs": {
    "author_buckets": {
      "terms": {
        "field": "author.job_title.keyword",
        "size": 5
      }
    }
  }
}
```
